<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Threat Digest - {{ digest_date }}</title>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Fraunces:opsz,wght@9..144,600;9..144,700&family=Space+Grotesk:wght@400;500;600&display=swap");

      :root {
        --ink: #1b1c20;
        --muted: #525866;
        --accent: #f05d23;
        --accent-soft: rgba(240, 93, 35, 0.15);
        --teal: #2a7f7f;
        --low: #2d7d5a;
        --med: #c9781e;
        --high: #b01f2a;
        --card: rgba(255, 255, 255, 0.88);
        --border: rgba(27, 28, 32, 0.1);
        --shadow: 0 18px 50px rgba(22, 27, 29, 0.15);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "Space Grotesk", "Noto Sans", sans-serif;
        color: var(--ink);
        background: radial-gradient(circle at top left, #f8f3ec 0%, #fdf8f2 40%, #f3f6f5 100%);
        min-height: 100vh;
      }

      body::before {
        content: "";
        position: fixed;
        inset: 0;
        background: linear-gradient(120deg, rgba(42, 127, 127, 0.12), transparent 60%),
          radial-gradient(circle at 80% 10%, rgba(240, 93, 35, 0.18), transparent 55%);
        pointer-events: none;
        z-index: -1;
      }

      header {
        padding: 3.5rem 6vw 2rem;
        display: grid;
        gap: 0.8rem;
      }

      .eyebrow {
        text-transform: uppercase;
        letter-spacing: 0.2em;
        font-size: 0.75rem;
        color: var(--teal);
        font-weight: 600;
      }

      h1 {
        font-family: "Fraunces", serif;
        font-size: clamp(2.2rem, 4vw, 3.5rem);
        margin: 0;
      }

      .subtitle {
        max-width: 48rem;
        color: var(--muted);
        font-size: 1.05rem;
        line-height: 1.6;
      }

      .meta-bar {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        font-size: 0.95rem;
        color: var(--muted);
      }

      .meta-bar span {
        background: rgba(255, 255, 255, 0.7);
        padding: 0.4rem 0.8rem;
        border-radius: 999px;
        border: 1px solid var(--border);
      }

      main {
        padding: 0 6vw 4rem;
        display: grid;
        gap: 3rem;
      }

      section {
        display: grid;
        gap: 1.5rem;
      }

      .section-title {
        display: flex;
        align-items: center;
        gap: 1rem;
        font-size: 1.4rem;
        font-weight: 600;
      }

      .pill {
        width: 10px;
        height: 10px;
        border-radius: 50%;
      }

      .themes {
        background: var(--card);
        border-radius: 20px;
        padding: 1.5rem;
        box-shadow: var(--shadow);
        border: 1px solid var(--border);
        display: grid;
        gap: 1rem;
      }

      .themes h2 {
        margin: 0;
        font-size: 1.3rem;
      }

      .themes ul {
        margin: 0;
        padding-left: 1.2rem;
        color: var(--muted);
      }

      .themes .rant {
        font-weight: 600;
      }

      .grid {
        display: grid;
        gap: 1.5rem;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      }

      .card {
        background: var(--card);
        border-radius: 20px;
        padding: 1.5rem;
        box-shadow: var(--shadow);
        border: 1px solid var(--border);
        display: grid;
        gap: 0.9rem;
        animation: rise 0.6s ease both;
        animation-delay: calc(var(--i) * 70ms);
      }

      @keyframes rise {
        from {
          opacity: 0;
          transform: translateY(12px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .card h3 {
        margin: 0;
        font-size: 1.15rem;
      }

      .card a {
        color: var(--ink);
        text-decoration: none;
      }

      .card a:hover {
        color: var(--accent);
      }

      .meta {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem 1rem;
        font-size: 0.85rem;
        color: var(--muted);
      }

      .chip {
        padding: 0.15rem 0.6rem;
        border-radius: 999px;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.7rem;
        letter-spacing: 0.08em;
      }

      .risk-high {
        background: rgba(176, 31, 42, 0.12);
        color: var(--high);
      }

      .risk-medium {
        background: rgba(201, 120, 30, 0.12);
        color: var(--med);
      }

      .risk-low {
        background: rgba(45, 125, 90, 0.12);
        color: var(--low);
      }

      .stage {
        background: rgba(42, 127, 127, 0.12);
        color: var(--teal);
      }

      .text-block {
        color: var(--muted);
        line-height: 1.6;
      }

      .label {
        font-weight: 600;
        color: var(--ink);
      }

      details {
        background: rgba(255, 255, 255, 0.7);
        padding: 0.6rem 0.8rem;
        border-radius: 12px;
        border: 1px solid var(--border);
      }

      details summary {
        cursor: pointer;
        font-weight: 600;
        color: var(--ink);
      }

      details ul {
        margin: 0.6rem 0 0;
        padding-left: 1.2rem;
        color: var(--muted);
      }

      .list {
        margin: 0.3rem 0 0;
        padding-left: 1.2rem;
        color: var(--muted);
      }

      .tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.4rem;
        font-size: 0.8rem;
        color: var(--teal);
      }

      .tags span {
        background: rgba(42, 127, 127, 0.12);
        padding: 0.2rem 0.6rem;
        border-radius: 999px;
      }

      .confidence {
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--muted);
      }

      .empty {
        margin: 0;
        color: var(--muted);
      }

      .archive {
        padding: 2rem 6vw 4rem;
        border-top: 1px solid var(--border);
        display: grid;
        gap: 1rem;
      }

      .archive-list {
        display: flex;
        flex-wrap: wrap;
        gap: 0.7rem;
      }

      .archive-list a {
        text-decoration: none;
        color: var(--ink);
        background: rgba(255, 255, 255, 0.8);
        padding: 0.4rem 0.8rem;
        border-radius: 999px;
        border: 1px solid var(--border);
      }

      footer {
        padding: 0 6vw 3rem;
        color: var(--muted);
        font-size: 0.85rem;
      }

      @media (max-width: 720px) {
        header {
          padding: 2.5rem 7vw 1.5rem;
        }

        main {
          padding: 0 7vw 3rem;
        }

        .meta-bar {
          flex-direction: column;
          align-items: flex-start;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <div class="eyebrow">Spicy-but-Educational Digest</div>
      <h1>Threat Digest - {{ digest_date }}</h1>
      <p class="subtitle">
        Straight talk from a tired SOC analyst. Clear explanations, mild sarcasm, and no mystery jargon.
      </p>
      <div class="meta-bar">
        <span>Generated at: {{ generated_at }}</span>
        <span>Archive days: {{ archive_links | length }}</span>
        <span>Tone mode: {{ tone_mode }}</span>
      </div>
    </header>

    <main>
      <section class="themes">
        <h2>Today's Themes</h2>
        {% if themes_data %}
          <ul>
            {% for theme in themes_data.themes %}
            <li>{{ theme }}</li>
            {% endfor %}
          </ul>
          <div class="rant">{{ themes_data.one_line_rant }}</div>
        {% else %}
          <p class="empty">No themes available yet.</p>
        {% endif %}
      </section>

      {% for label, items in sections %}
      <section>
        <div class="section-title">
          <span class="pill" style="background: {% if label == 'High' %}var(--high){% elif label == 'Medium' %}var(--med){% else %}var(--low){% endif %};"></span>
          {{ label }} Risk
        </div>
        {% if items %}
          <div class="grid">
            {% for item in items %}
            <article class="card" style="--i: {{ loop.index0 }};">
              <div class="meta">
                <span class="chip risk-{{ label | lower }}">{{ item.risk }}</span>
                <span class="chip stage">{{ item.attack_stage }}</span>
                <span>{{ item.source }}</span>
                <span>{{ item.published }}</span>
              </div>
              <h3><a href="{{ item.url }}" target="_blank" rel="noopener">{{ item.title }}</a></h3>
              <div class="text-block"><span class="label">Spicy take:</span> {{ item.spicy_take }}</div>
              <div class="text-block"><span class="label">TL;DR:</span> {{ item.tl_dr }}</div>
              <div class="text-block"><span class="label">What happened:</span> {{ item.what_happened }}</div>
              <div class="text-block"><span class="label">Why it matters:</span> {{ item.why_it_matters }}</div>

              <details>
                <summary>Beginner breakdown</summary>
                <ul>
                  {% for entry in item.beginner_breakdown %}
                  <li>{{ entry }}</li>
                  {% endfor %}
                </ul>
              </details>

              <div>
                <div class="label">SOC focus</div>
                <ul class="list">
                  {% for focus in item.soc_focus %}
                  <li>{{ focus }}</li>
                  {% endfor %}
                </ul>
              </div>

              <div>
                <div class="label">Recommended actions</div>
                <ul class="list">
                  {% for action in item.recommended_actions %}
                  <li>{{ action }}</li>
                  {% endfor %}
                </ul>
              </div>

              <div class="tags">
                {% for tag in item.tags %}
                <span>#{{ tag }}</span>
                {% endfor %}
              </div>
              <div class="confidence">Confidence: {{ item.confidence }}</div>
            </article>
            {% endfor %}
          </div>
        {% else %}
          <p class="empty">No items in this band today.</p>
        {% endif %}
      </section>
      {% endfor %}
    </main>

    <aside class="archive">
      <strong>Archive</strong>
      <div class="archive-list">
        {% for archive_date in archive_links %}
        <a href="archive/{{ archive_date }}.html">{{ archive_date }}</a>
        {% endfor %}
      </div>
    </aside>

    <footer>
      Generated by the Threat Digest pipeline using free RSS sources and OpenAI summaries.
    </footer>
  </body>
</html>
